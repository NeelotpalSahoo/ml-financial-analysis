<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ML Financial Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 30px;
      background-color: #f8f9fa;
    }
    .card h3 {
      font-size: 2rem;
    }
    .pros, .cons {
      font-size: 0.95rem;
      padding-left: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">Find the best with Stock Analytics</h1>

    <!-- Summary Cards -->
    <div class="row mb-4 text-center">
      <div class="col-md-6 offset-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Total Companies Analyzed</h5>
            <h3 id="totalCompanies">0</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Link Buttons -->
    <div class="row mb-5 text-center">
      <div class="col-md-6 offset-md-3">
        <a href="pages/view_all.html" class="btn btn-primary btn-lg w-100 mb-3">View All Analyses</a>
      </div>
    </div>

    <!-- Insights Preview -->
    <div class="row">
      <div class="col-md-6">
        <div class="card border-success mb-3">
          <div class="card-header bg-success text-white">Common Pros</div>
          <div class="card-body pros" id="topPros">
            <ul class="list-group list-group-flush" id="commonProsList"></ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-danger mb-3">
          <div class="card-header bg-danger text-white">Common Cons</div>
          <div class="card-body cons" id="topCons">
            <ul class="list-group list-group-flush" id="commonConsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + JS -->
  <script>
    fetch('pages/get_all.php')
      .then(res => res.json())
      .then(data => {
        document.getElementById('totalCompanies').innerText = data.length;

        let allPros = {}, allCons = {};

        const fetchDetails = data.map(row =>
          fetch(`pages/company.php?id=${row.company_id}&json=1`).then(res => res.json())
        );

        Promise.all(fetchDetails).then(results => {
          results.forEach(entry => {
            if (Array.isArray(entry.pros)) {
              entry.pros.forEach(p => {
                allPros[p] = (allPros[p] || 0) + 1;
              });
            }

            if (Array.isArray(entry.cons)) {
              entry.cons.forEach(c => {
                allCons[c] = (allCons[c] || 0) + 1;
              });
            }
          });

          const sortAndSlice = obj => Object.entries(obj)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

          const topProsList = sortAndSlice(allPros);
          const topConsList = sortAndSlice(allCons);

          const prosUl = document.getElementById("commonProsList");
          const consUl = document.getElementById("commonConsList");

          topProsList.forEach(([text, count]) => {
            prosUl.innerHTML += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${text}
                <span class="badge bg-success rounded-pill">${count}</span>
              </li>`;
          });

          topConsList.forEach(([text, count]) => {
            consUl.innerHTML += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${text}
                <span class="badge bg-danger rounded-pill">${count}</span>
              </li>`;
          });
        });
      });
  </script>
</body>
</html>
